<!DOCTYPE html>
<html>
  <head>
    <title>Mockup Tools & Etsy Integration</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      :root {
        /* Color palette */
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --section-bg: #252525;
        --text-color: #e4e4e4;
        --text-secondary: #a0a0a0;
        --primary-color: #6200ee;
        --primary-hover: #7c4dff;
        --primary-light: rgba(98, 0, 238, 0.15);
        --secondary-color: #03dac6;
        --success-color: #4caf50;
        --error-color: #cf6679;
        --warning-color: #f39c12;
        --border-color: #444;
        --input-bg: #3d3d3d;
        --input-text: #e0e0e0;
        --log-bg: #2a2a2a;

        /* Component backgrounds */
        --tab-bg: #3d3d3d;
        --tab-active-bg: #6200ee;

        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;

        /* Border radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
        font-size: 16px;
      }

      .container {
        max-width: 900px;
        margin: var(--spacing-lg) auto;
        background-color: var(--container-bg);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        border-top: 4px solid var(--primary-color);
      }

      h1,
      h2,
      h3 {
        color: var(--secondary-color);
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .tab {
        padding: 12px 24px;
        cursor: pointer;
        background-color: var(--tab-bg);
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
        border: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
      }

      .tab:hover {
        background-color: #4a4a4a;
      }

      .tab.active {
        background-color: var(--tab-active-bg);
        color: white;
      }

      .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 0 0 8px 8px;
        background-color: var(--section-bg);
      }

      .tab-content.active {
        display: block;
      }

      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
        color: var(--secondary-color);
        font-size: 14px;
      }

      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-sizing: border-box;
        background-color: var(--input-bg);
        color: var(--input-text);
        font-family: inherit;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      input[type="text"]:hover,
      select:hover,
      textarea:hover {
        border-color: var(--primary-color);
      }

      input[type="text"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.15);
      }

      button {
        background-color: var(--primary-color);
        color: white;
        padding: 12px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 10px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .secondary-button {
        background-color: var(--section-bg);
        border: 1px solid var(--secondary-color);
        color: var(--secondary-color);
        box-shadow: none;
      }

      .secondary-button:hover {
        background-color: var(--secondary-color);
        color: var(--bg-color);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .primary-button {
        background-color: var(--primary-color);
        font-weight: 600;
      }

      .highlight-update {
        animation: highlight-fade 2s ease-in-out;
      }

      @keyframes highlight-fade {
        0% {
          background-color: rgba(3, 218, 198, 0.3);
        }
        100% {
          background-color: transparent;
        }
      }

      .info-box {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        background-color: rgba(52, 152, 219, 0.08);
        color: var(--text-color);
        border-left: 4px solid #3498db;
        padding: 20px;
        margin: 0;
        border-radius: 0;
        position: relative;
        overflow: hidden;
      }

      .info-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          rgba(52, 152, 219, 0.05) 0%,
          transparent 100%
        );
        pointer-events: none;
      }

      .info-box i {
        color: #3498db;
        font-size: 20px;
        margin-top: 2px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }

      .info-box p {
        margin: 0;
        line-height: 1.6;
        font-size: 14px;
        position: relative;
        z-index: 1;
      }

      .info-box strong {
        color: #3498db;
        font-weight: 600;
      }

      .view-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .view-button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .view-button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Add icons to buttons */
      .view-button::before {
        content: "\1F50D"; /* Magnifying glass emoji */
        font-size: 14px;
        margin-right: 4px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-content {
        background-color: var(--container-bg);
        margin: 5% auto;
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        width: 80%;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
        position: relative;
        border-top: 4px solid var(--primary-color);
      }

      .close {
        color: var(--text-secondary);
        position: absolute;
        top: var(--spacing-md);
        right: var(--spacing-md);
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .close:hover,
      .close:focus {
        color: var(--text-color);
        background-color: rgba(255, 255, 255, 0.1);
      }

      .modal-actions {
        margin-top: var(--spacing-lg);
        text-align: right;
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
      }

      /* Prepared listings styles */
      .prepared-listing {
        margin-bottom: 24px;
        padding: 24px;
        border-radius: 8px;
        background-color: var(--container-bg);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        border-left: 4px solid var(--primary-color);
      }

      .prepared-listing:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .prepared-listings-content {
        margin-top: 20px;
      }

      .prepared-listing h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: var(--primary-color);
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .prepared-listing h3::before {
        content: "\1F4E6"; /* Package emoji */
        font-size: 18px;
      }

      .prepared-listing-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .prepared-listing-info {
        width: 100%;
      }

      .prepared-listing-files {
        width: 100%;
        padding: var(--spacing-md);
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-sm);
        font-family: "Consolas", "Courier New", monospace;
        font-size: 14px;
      }

      .prepared-listing-files p {
        margin: 5px 0;
        display: flex;
        align-items: center;
      }

      .prepared-listing-files p::before {
        content: "\1F4C4"; /* File emoji */
        margin-right: var(--spacing-xs);
        font-size: 14px;
      }

      .prepared-listing-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-md);
      }

      .prepared-listing-tag {
        background-color: var(--primary-light);
        color: var(--primary-color);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .prepared-listing-tag:hover {
        background-color: var(--primary-color);
        color: white;
      }

      /* Bulk tab styling */
      .bulk-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: flex-end;
        margin-bottom: 20px;
      }

      .bulk-form-row .form-group {
        flex: 1;
        min-width: 200px;
        margin-bottom: 0;
      }

      .bulk-form-row .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: auto;
        flex: 0 0 auto;
      }

      .bulk-form-row .checkbox-group label {
        display: inline;
        margin-bottom: 0;
      }

      .bulk-actions {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .bulk-info-text {
        margin: 0;
        color: var(--text-secondary);
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .bulk-info-text i {
        color: var(--primary-color);
        font-size: 16px;
      }

      /* Etsy header and auth styling */
      .etsy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .etsy-auth-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .auth-button {
        background-color: #f56400;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }

      .auth-button:hover {
        background-color: #e05800;
      }

      .auth-button:disabled {
        background-color: #ccc;
        cursor: default;
        opacity: 0.7;
      }

      .auth-status {
        color: #4caf50;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .prepared-listing-actions {
        margin-top: var(--spacing-lg);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
      }

      .upload-button {
        background-color: var(--success-color);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .upload-button::before {
        content: "\2B06\FE0F"; /* Upload emoji */
        font-size: 14px;
      }

      .upload-button:hover {
        background-color: #4cda8e;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .upload-button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-lg);
        color: var(--text-secondary);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-md);
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        margin: 20px 0;
      }

      .empty-state i {
        font-size: 24px;
        color: var(--primary-color);
        opacity: 0.7;
        margin-bottom: 10px;
      }

      .empty-state p {
        margin: 0;
        line-height: 1.5;
      }

      /* Focus styles for accessibility */
      button:focus-visible,
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }

      /* Add a subtle transition when the page loads */
      .container {
        animation: fadeIn 0.5s ease-in-out;
      }

      .log-area {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--log-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        height: 200px;
        overflow-y: auto;
        font-family: "Consolas", "Courier New", monospace;
        color: #ddd;
      }

      .section {
        margin-bottom: 25px;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--section-bg);
      }

      .actions {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      /* Success message styling */
      #auth-status {
        color: var(--success-color) !important;
        font-weight: 500;
        margin-top: 10px;
      }

      /* Checkbox styling */
      input[type="checkbox"] {
        accent-color: var(--primary-color);
        width: 18px;
        height: 18px;
        vertical-align: middle;
      }

      /* Counter and validation styling */
      .counter {
        font-size: 0.8em;
        margin-left: 8px;
        color: var(--text-color);
      }

      .counter.warning {
        color: orange;
      }

      .counter.error {
        color: var(--error-color);
      }

      .validation-message {
        font-size: 0.85em;
        margin-top: 4px;
        min-height: 1.2em;
      }

      .validation-message.error {
        color: var(--error-color);
      }

      .validation-message.warning {
        color: orange;
      }

      /* Log section styling */
      .log-section {
        margin-top: 32px;
        background-color: var(--section-bg);
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .log-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .log-title::before {
        content: "\1F4DD"; /* Memo emoji */
        font-size: 18px;
      }

      .log-controls {
        display: flex;
        gap: 12px;
      }

      .log-button {
        padding: 8px 14px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .log-button i {
        font-size: 14px;
      }

      .log-button.active {
        background-color: var(--secondary-color);
      }

      .log-area {
        padding: 16px;
        background-color: var(--log-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        height: 300px;
        overflow-y: auto;
        font-family: "JetBrains Mono", "Fira Code", "SF Mono", "Roboto Mono",
          monospace;
        font-size: 14px;
        line-height: 1.6;
      }

      /* Bulk tab styling */
      .bulk-preparation-section {
        margin-bottom: 32px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
      }

      .prepared-listings-section {
        margin-bottom: 32px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
      }

      .bulk-form-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 24px;
        padding: 0 8px;
        animation: slideIn 0.4s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background-color: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .checkbox-group:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }

      .checkbox-group label {
        margin: 0;
        font-weight: 500;
        cursor: pointer;
      }

      .bulk-actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-start;
      }

      .info-box {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        background-color: rgba(98, 0, 238, 0.08);
        border-left: 4px solid var(--primary-color);
        padding: 16px;
        border-radius: 6px;
        margin-top: 20px;
      }

      .info-box i {
        color: var(--primary-color);
        font-size: 18px;
        margin-top: 2px;
      }

      .info-box p {
        margin: 0;
        line-height: 1.5;
      }

      .prepared-listings-content {
        padding: 24px;
        background-color: var(--container-bg);
        min-height: 200px;
        position: relative;
      }

      .loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: var(--text-secondary);
        text-align: center;
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: var(--container-bg);
      }

      .loading i {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.7;
        animation: pulse 2s infinite ease-in-out;
      }

      @keyframes pulse {
        0% {
          opacity: 0.5;
          transform: scale(0.95);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.05);
        }
        100% {
          opacity: 0.5;
          transform: scale(0.95);
        }
      }

      .loading p {
        margin: 0;
        font-size: 16px;
        max-width: 300px;
        line-height: 1.6;
      }

      .enhanced-select {
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--container-bg);
        color: var(--text-color);
        width: 100%;
        max-width: 300px;
        font-family: inherit;
        font-size: 14px;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0a0a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 16px top 50%;
        background-size: 12px auto;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) inset;
      }

      .enhanced-select:hover {
        border-color: var(--primary-color);
        background-color: rgba(255, 255, 255, 0.03);
      }

      .enhanced-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.15),
          0 2px 4px rgba(0, 0, 0, 0.1) inset;
        background-color: rgba(255, 255, 255, 0.05);
      }

      .log-entry {
        margin-bottom: 6px;
        padding-bottom: 6px;
        border-bottom: 1px dotted rgba(255, 255, 255, 0.1);
      }

      .log-entry.command {
        color: var(--secondary-color);
        font-weight: bold;
      }

      .log-entry.error {
        color: var(--error-color);
      }

      .log-entry.success {
        color: var(--success-color);
      }

      /* Etsy sub-tabs styles */
      .etsy-tabs {
        display: flex;
        margin: 32px 0 24px;
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }

      .etsy-tabs::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, var(--primary-color), transparent);
        opacity: 0.5;
      }

      .etsy-tab {
        padding: 12px 24px;
        background-color: var(--tab-bg);
        border: none;
        border-radius: 8px 8px 0 0;
        color: var(--text-color);
        cursor: pointer;
        margin-right: 8px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        position: relative;
        box-shadow: none;
        margin-bottom: -1px;
      }

      .etsy-tab:hover {
        background-color: rgba(255, 255, 255, 0.05);
        transform: translateY(-2px);
      }

      .etsy-tab.active {
        background-color: var(--tab-active-bg);
        color: white;
        border-bottom: 2px solid var(--primary-color);
      }

      .etsy-tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary-color);
      }

      .etsy-tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .etsy-tab-content.active {
        display: block;
      }

      .prepared-listing-tag {
        display: inline-block;
        background-color: var(--tag-bg);
        color: var(--text-color);
        padding: 3px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 12px;
      }

      .tag-danger {
        background-color: var(--error-color);
        color: white;
      }

      .text-danger {
        color: var(--error-color);
      }

      .text-warning {
        color: var(--warning-color);
      }

      .text-success {
        color: var(--success-color);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
      }

      textarea {
        background-color: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 8px;
        font-family: inherit;
        resize: vertical;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background-color: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid var(--border-color);
        position: relative;
      }

      .section-header::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, var(--primary-color), transparent);
        opacity: 0.5;
      }

      .section-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary-color);
      }

      .section-header h3 i {
        font-size: 18px;
        opacity: 0.9;
      }

      .section-actions {
        display: flex;
        gap: 12px;
      }

      .danger-button {
        background-color: var(--error-color);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .danger-button::before {
        content: "\26A0\FE0F"; /* Warning emoji */
        font-size: 14px;
      }

      .danger-button:hover {
        background-color: #ff7070;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .danger-button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      /* Etsy edit link styling */
      .etsy-edit-link {
        display: inline-block;
        padding: 8px 12px;
        background-color: #f56400;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        margin: 5px 0;
        transition: all 0.2s ease;
      }

      .etsy-edit-link:hover {
        background-color: #e05800;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .etsy-edit-link:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Mockup Tools & Etsy Integration</h1>

      <div class="tabs">
        <button class="tab active" id="pattern-tab">Pattern</button>
        <button class="tab" id="clipart-tab">Clipart</button>
        <button class="tab" id="etsy-tab">Etsy</button>
      </div>

      <div id="pattern" class="tab-content active">
        <h2>Pattern Tools</h2>

        <div class="section">
          <h3>Input Directory</h3>
          <div class="form-group">
            <label for="pattern-input-dir">Input Directory:</label>
            <input
              type="text"
              id="pattern-input-dir"
              name="pattern-input-dir"
              value="input"
            />
          </div>

          <div class="form-group">
            <label for="ai-provider">AI Provider:</label>
            <select id="ai-provider" name="ai-provider" class="enhanced-select">
              <option value="">Auto-detect</option>
              <option value="gemini">Gemini</option>
              <option value="openrouter">OpenRouter</option>
            </select>
          </div>

          <div class="actions">
            <button onclick="runPatternWorkflow()">
              Run Complete Workflow
            </button>
            <button onclick="runPatternResize()">Resize Only</button>
            <button onclick="runPatternMockups()">Create Mockups Only</button>
            <button
              onclick="runFolderRename('pattern')"
              class="secondary-button"
            >
              <i class="fas fa-tag"></i> Rename Folders
            </button>
          </div>
        </div>
      </div>

      <div id="clipart" class="tab-content">
        <h2>Clipart Tools</h2>

        <div class="section">
          <h3>Input Directory</h3>
          <div class="form-group">
            <label for="clipart-input-dir">Input Directory:</label>
            <input
              type="text"
              id="clipart-input-dir"
              name="clipart-input-dir"
              value="input"
            />
          </div>

          <div class="form-group">
            <label for="clipart-ai-provider">AI Provider:</label>
            <select
              id="clipart-ai-provider"
              name="clipart-ai-provider"
              class="enhanced-select"
            >
              <option value="">Auto-detect</option>
              <option value="gemini">Gemini</option>
              <option value="openrouter">OpenRouter</option>
            </select>
          </div>

          <div class="actions">
            <button onclick="runClipartWorkflow()">
              Run Complete Workflow
            </button>
            <button onclick="runClipartResize()">Resize Only</button>
            <button onclick="runClipartMockups()">Create Mockups Only</button>
            <button onclick="runClipartCropMulti()">
              Extract Multiple Images
            </button>
            <button
              onclick="runFolderRename('clipart')"
              class="secondary-button"
            >
              <i class="fas fa-tag"></i> Rename Folders
            </button>
          </div>
        </div>
      </div>

      <div id="etsy" class="tab-content">
        <div class="etsy-header">
          <h2>Etsy Integration</h2>
          <div class="etsy-auth-container">
            <button
              id="auth-button"
              onclick="authenticateEtsy()"
              class="auth-button"
              title="Authenticate with Etsy"
            >
              <i class="fas fa-key"></i> Connect Etsy
            </button>
            <div id="auth-status" class="auth-status"></div>
          </div>
        </div>

        <!-- Etsy sub-tabs -->
        <div class="etsy-tabs">
          <button class="etsy-tab active" id="etsy-single-tab">
            <i class="fas fa-file"></i> Single Listing
          </button>
          <button class="etsy-tab" id="etsy-bulk-tab">
            <i class="fas fa-layer-group"></i> Bulk Listings
          </button>
        </div>

        <!-- Single listing tab content -->
        <div id="etsy-single" class="etsy-tab-content active">
          <div class="section">
            <h3>Create Single Listing</h3>
            <div class="form-group">
              <label for="etsy-subfolder">Select Subfolder from 'input':</label>
              <select id="etsy-subfolder" name="etsy-subfolder">
                <option value="">-- Select a subfolder --</option>
                <!-- Will be populated dynamically -->
              </select>
              <button onclick="refreshSubfolders()" style="margin-top: 5px">
                Refresh Subfolders
              </button>
            </div>

            <div class="form-group">
              <label for="etsy-product-type">Product Type:</label>
              <select id="etsy-product-type" name="etsy-product-type">
                <option value="pattern">Pattern</option>
                <option value="clipart">Clipart</option>
                <option value="wall_art">Wall Art</option>
              </select>
            </div>

            <div class="form-group">
              <label for="etsy-title"
                >Title:
                <span id="title-counter" class="counter">0/140</span></label
              >
              <input
                type="text"
                id="etsy-title"
                name="etsy-title"
                placeholder="Enter listing title (max 140 characters)"
                oninput="updateTitleCounter()"
              />
              <div id="title-validation" class="validation-message"></div>
            </div>

            <div class="form-group">
              <label for="etsy-description">Description:</label>
              <textarea
                id="etsy-description"
                name="etsy-description"
                rows="5"
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  box-sizing: border-box;
                "
                placeholder="Enter listing description"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="etsy-tags"
                >Tags (comma separated):
                <span id="tags-counter" class="counter">0/13</span></label
              >
              <input
                type="text"
                id="etsy-tags"
                name="etsy-tags"
                placeholder="tag1, tag2, tag3 (max 13 tags, each max 20 chars)"
                oninput="updateTagsCounter()"
              />
              <div id="tags-validation" class="validation-message"></div>
            </div>
          </div>

          <div class="form-group">
            <input type="checkbox" id="etsy-draft" name="etsy-draft" checked />
            <label for="etsy-draft" style="display: inline"
              >Create as Draft</label
            >
          </div>

          <div class="actions">
            <button onclick="generateEtsyListing()" class="secondary-button">
              Generate Listing Content
            </button>
            <button onclick="createEtsyListing()">Create Listing</button>
          </div>
        </div>
      </div>

      <!-- Bulk listings tab content -->
      <div id="etsy-bulk" class="etsy-tab-content">
        <div class="section bulk-preparation-section">
          <div class="section-header">
            <h3><i class="fas fa-layer-group"></i> Bulk Listing Preparation</h3>
          </div>

          <div class="bulk-form-container">
            <div class="bulk-form-row">
              <div class="form-group">
                <label for="etsy-bulk-product-type">Product Type:</label>
                <select
                  id="etsy-bulk-product-type"
                  name="etsy-bulk-product-type"
                  class="enhanced-select"
                >
                  <option value="pattern">Pattern</option>
                  <option value="clipart">Clipart</option>
                  <option value="wall_art">Wall Art</option>
                </select>
              </div>

              <div class="form-group">
                <label for="bulk-ai-provider">AI Provider:</label>
                <select
                  id="bulk-ai-provider"
                  name="bulk-ai-provider"
                  class="enhanced-select"
                >
                  <option value="">Default</option>
                  <option value="gemini">Gemini</option>
                  <option value="openrouter">OpenRouter</option>
                </select>
              </div>

              <div class="form-group checkbox-group">
                <input
                  type="checkbox"
                  id="etsy-bulk-draft"
                  name="etsy-bulk-draft"
                  checked
                />
                <label for="etsy-bulk-draft">Create as Draft</label>
              </div>
            </div>

            <div class="actions bulk-actions">
              <button onclick="prepareBulkListings()" class="primary-button">
                <i class="fas fa-cogs"></i> Prepare Bulk Listings
              </button>
              <p class="bulk-info-text">
                <i class="fas fa-info-circle"></i>
                Generates mockups, zip files, and listing content for all
                subfolders in the input directory.
              </p>
            </div>
          </div>
        </div>

        <div class="section prepared-listings-section">
          <div class="section-header">
            <h3><i class="fas fa-list-alt"></i> Prepared Listings</h3>
            <div class="section-actions">
              <button
                onclick="showPreparedListings()"
                class="secondary-button"
                title="Refresh the prepared listings"
              >
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <button
                onclick="deletePreparedListings()"
                class="danger-button"
                title="Delete all prepared listings"
              >
                <i class="fas fa-trash-alt"></i> Clear All
              </button>
            </div>
          </div>
          <div
            id="prepared-listings-container"
            class="prepared-listings-content"
          >
            <div class="empty-state">
              <i class="fas fa-layer-group"></i>
              <p>
                No prepared listings yet. Click "Prepare Bulk Listings" to
                generate mockups, zip files, and listing content for all
                subfolders.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="section log-section">
        <div class="log-header">
          <h3 class="log-title">Command Log</h3>
          <div class="log-controls">
            <button onclick="clearLog()" class="log-button">
              <i class="fas fa-trash-alt"></i> Clear Log
            </button>
            <button
              onclick="toggleAutoScroll()"
              id="autoscroll-button"
              class="log-button active"
            >
              <i class="fas fa-scroll"></i> Auto-scroll: ON
            </button>
          </div>
        </div>
        <div class="log-area" id="log"></div>
      </div>
    </div>

    <script>
      // Title counter and validation
      function updateTitleCounter() {
        const titleInput = document.getElementById("etsy-title");
        const titleCounter = document.getElementById("title-counter");
        const titleValidation = document.getElementById("title-validation");
        const maxLength = 140;
        const currentLength = titleInput.value.length;

        // Update counter
        titleCounter.textContent = `${currentLength}/${maxLength}`;

        // Update counter class
        titleCounter.className = "counter";
        if (currentLength > maxLength * 0.8 && currentLength <= maxLength) {
          titleCounter.classList.add("warning");
        } else if (currentLength > maxLength) {
          titleCounter.classList.add("error");
        }

        // Update validation message
        titleValidation.textContent = "";
        titleValidation.className = "validation-message";
        if (currentLength > maxLength) {
          titleValidation.textContent = `Title is too long by ${
            currentLength - maxLength
          } characters.`;
          titleValidation.classList.add("error");
        }
      }

      // Tags counter and validation
      function updateTagsCounter() {
        const tagsInput = document.getElementById("etsy-tags");
        const tagsCounter = document.getElementById("tags-counter");
        const tagsValidation = document.getElementById("tags-validation");
        const maxTags = 13;
        const maxTagLength = 20;

        // Process tags
        const tags = tagsInput.value
          .split(",")
          .map((tag) => tag.trim())
          .filter((tag) => tag.length > 0);

        // Update counter
        tagsCounter.textContent = `${tags.length}/${maxTags}`;

        // Update counter class
        tagsCounter.className = "counter";
        if (tags.length > maxTags * 0.8 && tags.length <= maxTags) {
          tagsCounter.classList.add("warning");
        } else if (tags.length > maxTags) {
          tagsCounter.classList.add("error");
        }

        // Check for long tags
        const longTags = tags.filter((tag) => tag.length > maxTagLength);

        // Update validation message
        tagsValidation.textContent = "";
        tagsValidation.className = "validation-message";

        if (tags.length > maxTags) {
          tagsValidation.textContent = `Too many tags (${
            tags.length
          }/${maxTags}). Please remove ${tags.length - maxTags} tag(s).`;
          tagsValidation.classList.add("error");
        } else if (longTags.length > 0) {
          tagsValidation.textContent = `${
            longTags.length
          } tag(s) exceed the 20 character limit: ${longTags.join(", ")}`;
          tagsValidation.classList.add("error");
        }
      }

      // Add event listeners to tab buttons
      document.addEventListener("DOMContentLoaded", function () {
        // Pattern tab
        document
          .getElementById("pattern-tab")
          .addEventListener("click", function () {
            showTab("pattern");
          });

        // Clipart tab
        document
          .getElementById("clipart-tab")
          .addEventListener("click", function () {
            showTab("clipart");
          });

        // Etsy tab
        document
          .getElementById("etsy-tab")
          .addEventListener("click", function () {
            showTab("etsy");
            // Refresh subfolders when switching to Etsy tab
            refreshSubfolders();
            // Initialize counters
            updateTitleCounter();
            updateTagsCounter();
          });

        // Check for authentication status
        checkLogForAuthStatus();

        // Initial refresh of subfolders
        refreshSubfolders();

        // Initialize counters
        updateTitleCounter();
        updateTagsCounter();
      });

      // Function to show a tab
      function showTab(tabId) {
        console.log("Showing tab:", tabId);

        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabId).classList.add("active");

        // Update tab buttons
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Activate the correct tab button
        document.getElementById(tabId + "-tab").classList.add("active");
      }

      // Auto-scroll state
      let autoScroll = true;

      // Toggle auto-scroll
      function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const button = document.getElementById("autoscroll-button");
        if (autoScroll) {
          button.innerHTML = '<i class="fas fa-scroll"></i> Auto-scroll: ON';
          button.classList.add("active");
          // Scroll to bottom immediately when turning on
          const logArea = document.getElementById("log");
          logArea.scrollTop = logArea.scrollHeight;
        } else {
          button.innerHTML = '<i class="fas fa-scroll"></i> Auto-scroll: OFF';
          button.classList.remove("active");
        }
      }

      // Format log message with timestamp
      function formatLogMessage(message) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        let cssClass = "log-entry";

        // Add specific styling based on message content
        if (
          message.includes("Command submitted:") ||
          message.includes("Running command:")
        ) {
          cssClass += " command";
        } else if (message.includes("Error") || message.includes("failed")) {
          cssClass += " error";
        } else if (
          message.includes("successfully") ||
          message.includes("Authentication successful")
        ) {
          cssClass += " success";
        }

        return `<div class="${cssClass}">[${timestamp}] ${message}</div>`;
      }

      // Log message
      function log(message) {
        const logArea = document.getElementById("log");

        // Format the message
        let formattedMessage = message;

        // If the message contains HTML (like links), don't escape it
        if (message.includes("<a ") || message.includes("<button ")) {
          const timestamp = new Date().toLocaleTimeString();
          let cssClass = "log-entry";

          // Add specific styling based on message content
          if (
            message.includes("Command submitted:") ||
            message.includes("Running command:")
          ) {
            cssClass += " command";
          } else if (message.includes("Error") || message.includes("failed")) {
            cssClass += " error";
          } else if (
            message.includes("successfully") ||
            message.includes("Authentication successful")
          ) {
            cssClass += " success";
          }

          logArea.innerHTML += `<div class="${cssClass}">[${timestamp}] ${message}</div>`;
        } else {
          // Use the regular formatter for non-HTML messages
          logArea.innerHTML += formatLogMessage(message);
        }

        // Only auto-scroll if enabled
        if (autoScroll) {
          logArea.scrollTop = logArea.scrollHeight;
        }
      }

      // Clear log
      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      // Check for new log messages
      function checkLog() {
        fetch("/log")
          .then((response) => response.json())
          .then((data) => {
            if (data.messages && data.messages.length > 0) {
              data.messages.forEach((message) => {
                log(message);
              });
            }

            // Check again in 1 second
            setTimeout(checkLog, 1000);
          })
          .catch((error) => {
            console.error("Error checking log:", error);
            // Try again in 5 seconds
            setTimeout(checkLog, 5000);
          });
      }

      // Start checking for log messages
      checkLog();

      // Check for authentication status in log messages
      function checkLogForAuthStatus() {
        const logArea = document.getElementById("log");
        const logText = logArea.innerHTML;
        const authStatusDiv = document.getElementById("auth-status");
        const authButton = document.getElementById("auth-button");

        // Check if log contains authentication success messages
        if (
          logText.includes("Already authenticated with Etsy") ||
          logText.includes("Authentication successful")
        ) {
          // Show success message and disable button
          authStatusDiv.innerHTML =
            "<i class='fas fa-check-circle'></i> Connected";
          authButton.disabled = true;
        } else {
          // Clear success message and enable button
          authStatusDiv.innerHTML = "";
          authButton.disabled = false;
        }
      }

      // Set up a MutationObserver to watch for changes to the log
      const logArea = document.getElementById("log");
      const observer = new MutationObserver(function (mutations) {
        checkLogForAuthStatus();
      });
      observer.observe(logArea, { childList: true });

      // Pattern actions
      function runPatternWorkflow() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "pattern-workflow",
            inputDir: document.getElementById("pattern-input-dir").value,
            createVideo: true,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      function runPatternResize() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "pattern-resize",
            inputDir: document.getElementById("pattern-input-dir").value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      function runPatternMockups() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "pattern-mockups",
            inputDir: document.getElementById("pattern-input-dir").value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      // Clipart actions
      function runClipartWorkflow() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "clipart-workflow",
            inputDir: document.getElementById("clipart-input-dir").value,
            createVideo: true,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      function runClipartResize() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "clipart-resize",
            inputDir: document.getElementById("clipart-input-dir").value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      function runClipartMockups() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "clipart-mockups",
            inputDir: document.getElementById("clipart-input-dir").value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      function runClipartCropMulti() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "clipart-crop-multi",
            inputDir: document.getElementById("clipart-input-dir").value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
          });
      }

      // Folder renaming function
      function runFolderRename(type) {
        // Get the input directory based on the type
        const inputDir =
          type === "pattern"
            ? document.getElementById("pattern-input-dir").value
            : document.getElementById("clipart-input-dir").value;

        // Default parameters
        const params = {
          command: "folder-rename",
          inputDir: inputDir,
          maxRetries: 2, // Default to 2 retries
        };

        // Get the selected provider if any
        const providerSelect =
          type === "pattern"
            ? document.getElementById("ai-provider")
            : document.getElementById("clipart-ai-provider");
        if (providerSelect && providerSelect.value) {
          params.provider = providerSelect.value;
        }

        // Show a loading message
        log("Starting folder renaming process...");
        log("This may take a moment as we analyze your images.");

        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(params),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
            log("Renaming folders based on image analysis...");
            // Refresh subfolders after a delay to allow the command to complete
            setTimeout(() => {
              log("Refreshing folder list...");
              refreshSubfolders();
            }, 5000);
          })
          .catch((error) => {
            log("Error: " + error);
          });
      }

      // Etsy actions
      function authenticateEtsy() {
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-auth",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Command submitted: " + data.command);
            // Check auth status after a delay to allow the command to complete
            setTimeout(checkLogForAuthStatus, 3000);
          });
      }

      // Function to refresh the list of subfolders in the input directory
      function refreshSubfolders() {
        fetch("/get-subfolders")
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("etsy-subfolder");

            // Save the current selection if any
            const currentSelection = select.value;

            // Clear all options except the first one
            while (select.options.length > 1) {
              select.remove(1);
            }

            // Add new options
            data.subfolders.forEach((subfolder) => {
              const option = document.createElement("option");
              option.value = subfolder;
              option.text = subfolder;
              select.add(option);
            });

            // Restore selection if it still exists
            if (data.subfolders.includes(currentSelection)) {
              select.value = currentSelection;
            }

            log(
              "Refreshed subfolders list: " +
                data.subfolders.length +
                " folders found"
            );
          })
          .catch((error) => {
            console.error("Error refreshing subfolders:", error);
            log("Error refreshing subfolders: " + error);
          });
      }

      function generateEtsyListing() {
        const subfolder = document.getElementById("etsy-subfolder").value;
        const productType = document.getElementById("etsy-product-type").value;

        // Validate inputs
        if (!subfolder) {
          alert("Please select a subfolder from the input directory.");
          return;
        }

        // Construct the full folder path
        const folder = "input/" + subfolder;

        // Show loading message
        log("Generating listing content for " + subfolder + "...");

        // Disable the button and show loading state
        const generateButton = document.querySelector(
          ".actions button.secondary-button"
        );
        const originalText = generateButton.textContent;
        generateButton.disabled = true;
        generateButton.textContent = "Generating...";

        // Call the API to generate content
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-generate",
            folder: folder,
            productType: productType,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((data) => {
            log("Content generation completed.");

            // If content is returned directly, update the form fields
            if (data.content) {
              // Log the content for debugging
              console.log("Content received from server:", data.content);
              log(
                "Content received from server - Title length: " +
                  (data.content.title ? data.content.title.length : 0) +
                  ", Description length: " +
                  (data.content.description
                    ? data.content.description.length
                    : 0) +
                  ", Tags count: " +
                  (data.content.tags ? data.content.tags.length : 0)
              );

              // Update the form fields
              document.getElementById("etsy-title").value =
                data.content.title || "";

              // Format description with proper spacing between emoji sections
              let description = data.content.description || "";
              // Add extra line breaks before emoji sections for better readability
              description = description.replace(
                /([^\n])(\n*[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}])/gu,
                "$1\n\n$2"
              );
              document.getElementById("etsy-description").value = description;

              document.getElementById("etsy-tags").value = (
                data.content.tags || []
              ).join(", ");

              // Update counters
              updateTitleCounter();
              updateTagsCounter();

              log("Listing content applied to form fields.");

              // Highlight the fields that were updated
              const titleField = document.getElementById("etsy-title");
              const descriptionField =
                document.getElementById("etsy-description");
              const tagsField = document.getElementById("etsy-tags");

              // Add a temporary highlight class
              titleField.classList.add("highlight-update");
              descriptionField.classList.add("highlight-update");
              tagsField.classList.add("highlight-update");

              // Remove the highlight after a delay
              setTimeout(() => {
                titleField.classList.remove("highlight-update");
                descriptionField.classList.remove("highlight-update");
                tagsField.classList.remove("highlight-update");
              }, 2000);
            }
          })
          .catch((error) => {
            alert(error.message);
            log("Error: " + error.message);
          })
          .finally(() => {
            // Re-enable the button and restore text
            generateButton.disabled = false;
            generateButton.textContent = originalText;
          });
      }

      function createEtsyListing() {
        const subfolder = document.getElementById("etsy-subfolder").value;
        const productType = document.getElementById("etsy-product-type").value;
        const title = document.getElementById("etsy-title").value;
        const description = document.getElementById("etsy-description").value;
        const tagsInput = document.getElementById("etsy-tags").value;
        const draft = document.getElementById("etsy-draft").checked;

        // Validate inputs
        if (!subfolder) {
          alert("Please select a subfolder from the input directory.");
          return;
        }

        // Validate title length (max 140 characters)
        if (title.length > 140) {
          alert(
            `Title is too long (${title.length} characters). Etsy allows a maximum of 140 characters.`
          );
          return;
        }

        // Process tags - split by comma and trim whitespace
        const tags = tagsInput
          .split(",")
          .map((tag) => tag.trim())
          .filter((tag) => tag.length > 0);

        // Validate tags (max 13 for Etsy)
        if (tags.length > 13) {
          alert(
            "Etsy allows a maximum of 13 tags. Please reduce the number of tags."
          );
          return;
        }

        // Validate individual tag length (max 20 characters each)
        const longTags = tags.filter((tag) => tag.length > 20);
        if (longTags.length > 0) {
          alert(
            `The following tags are too long (max 20 characters each): ${longTags.join(
              ", "
            )}`
          );
          return;
        }

        // Construct the full folder path
        const folder = "input/" + subfolder;

        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-create",
            folder: folder,
            productType: productType,
            title: title,
            description: description,
            tags: tags,
            draft: draft,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((data) => {
            log("Command submitted: " + data.command);
          })
          .catch((error) => {
            alert(error.message);
            log("Error: " + error.message);
          });
      }

      function prepareBulkListings() {
        const productType = document.getElementById(
          "etsy-bulk-product-type"
        ).value;
        const provider = document.getElementById("bulk-ai-provider").value;

        // Confirm with the user
        if (
          !confirm(
            `This will prepare Etsy listings for ALL subfolders in the input directory using the ${productType} product type. Continue?`
          )
        ) {
          return;
        }

        // Show loading message
        log(
          `Starting bulk preparation of ${productType} listings from input directory...`
        );

        // Log the AI provider being used
        if (provider) {
          log(`Using AI provider: ${provider}`);
        } else {
          log("Using default AI provider");
        }

        // Disable the button and show loading state
        const prepareButton = document.querySelector(
          "button[onclick='prepareBulkListings()'"
        );
        const originalText = prepareButton.textContent;
        prepareButton.disabled = true;
        prepareButton.textContent = "Processing...";

        // Prepare the request parameters
        const requestParams = {
          command: "etsy-bulk-prepare",
          productType: productType,
        };

        // Add provider if specified
        if (provider) {
          requestParams.provider = provider;
        }

        // Call the API to prepare listings in bulk
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestParams),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((data) => {
            log(
              "Bulk listing preparation complete. Check the logs for details."
            );
            log("You can now view and upload the prepared listings.");

            // Automatically show the prepared listings after a short delay
            // to ensure the file is fully written
            log("Loading prepared listings...");
            setTimeout(() => {
              showPreparedListings();
            }, 1000); // 1 second delay
          })
          .catch((error) => {
            alert(error.message);
            log("Error: " + error.message);
          })
          .finally(() => {
            // Re-enable the button and restore text
            prepareButton.disabled = false;
            prepareButton.textContent = originalText;
          });
      }

      function deletePreparedListings() {
        // Confirm with the user
        if (
          !confirm(
            "Are you sure you want to delete all prepared listings? This cannot be undone."
          )
        ) {
          return;
        }

        // Show loading message
        log("Deleting prepared listings...");

        // Call the API to delete the prepared listings file
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-delete-prepared",
            file: "prepared_listings.json",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              log(data.message);
              // Update the UI
              const container = document.getElementById(
                "prepared-listings-container"
              );
              container.innerHTML =
                '<div class="empty-state"><i class="fas fa-layer-group"></i><p>No prepared listings. Click "Prepare Bulk Listings" to get started.</p></div>';
            } else {
              log("Error: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            log("Error: " + error.message);
          });
      }

      function showPreparedListings(retryCount = 0) {
        // Get the container in the bulk tab
        const container = document.getElementById(
          "prepared-listings-container"
        );

        // Make sure the bulk tab is active
        document.querySelectorAll(".etsy-tab").forEach((t) => {
          t.classList.remove("active");
        });
        document.getElementById("etsy-bulk-tab").classList.add("active");

        document.querySelectorAll(".etsy-tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById("etsy-bulk").classList.add("active");

        // Show loading state
        container.innerHTML =
          '<div class="empty-state"><i class="fas fa-sync-alt fa-spin"></i><p>Loading prepared listings' +
          (retryCount > 0 ? ` (retry ${retryCount}/3)` : "") +
          "...</p></div>";

        // Fetch prepared listings
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-get-prepared",
            file: "prepared_listings.json",
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.count === 0) {
              container.innerHTML =
                '<div class="empty-state"><i class="fas fa-info-circle"></i><p>No prepared listings found. Please prepare listings first.</p></div>';
              return;
            }

            // Render the listings
            renderPreparedListings(data.listings);
          })
          .catch((error) => {
            // If the file is not found and we haven't exceeded retry attempts, try again
            if (error.message.includes("not found") && retryCount < 3) {
              log(
                `Prepared listings file not found yet. Retrying in 2 seconds... (${
                  retryCount + 1
                }/3)`
              );
              setTimeout(() => {
                showPreparedListings(retryCount + 1);
              }, 2000);
            } else {
              container.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error: ${error.message}</p></div>`;
              log("Error: " + error.message);
            }
          });
      }

      function renderPreparedListings(listings) {
        const container = document.getElementById(
          "prepared-listings-container"
        );
        let html = "";

        listings.forEach((listing, index) => {
          // Get the first mockup image
          const mockupImage =
            listing.mockup_images_rel && listing.mockup_images_rel.length > 0
              ? listing.mockup_images_rel[0]
              : "";

          // Get the zip files
          const zipFiles = listing.zip_files_rel || [];

          // Calculate title character count
          const titleLength = listing.title ? listing.title.length : 0;
          const titleClass =
            titleLength > 140
              ? "text-danger"
              : titleLength > 130
              ? "text-warning"
              : "text-success";

          // Format tags with validation
          const formattedTags = listing.tags
            .map((tag) => {
              const tagLength = tag.length;
              const tagClass = tagLength > 20 ? "tag-danger" : "";
              return `<span class="prepared-listing-tag ${tagClass}" title="${tagLength} characters">${tag}</span>`;
            })
            .join("");

          html += `
            <div class="prepared-listing" data-index="${index}">
              <h3>${listing.folder_name}</h3>
              <div class="prepared-listing-details">
                <div class="prepared-listing-info">
                  <div class="form-group">
                    <label><strong>Title:</strong> <span class="${titleClass}">(${titleLength}/140 characters)</span></label>
                    <textarea class="title-input" data-index="${index}" rows="3" style="width: 100%;">${
            listing.title
          }</textarea>
                  </div>

                  <div class="form-group">
                    <label><strong>Description:</strong></label>
                    <textarea class="description-input" data-index="${index}" rows="10" style="width: 100%;">${
            // Format description with proper spacing between emoji sections
            listing.description.replace(
              /([^\n])(\n*[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}])/gu,
              "$1\n\n$2"
            )
          }</textarea>
                  </div>

                  <div class="form-group">
                    <label><strong>Tags:</strong> <span class="tag-count">(${
                      listing.tags.length
                    }/13 tags)</span></label>
                    <div class="prepared-listing-tags">
                      ${formattedTags}
                    </div>
                    <textarea class="tags-input" data-index="${index}" rows="3" style="width: 100%;">${listing.tags.join(
            ", "
          )}</textarea>
                  </div>

                  <p><strong>Zip Files:</strong> ${
                    zipFiles.length > 0
                      ? zipFiles.map((zip) => zip.split("/").pop()).join(", ")
                      : "None"
                  }</p>
                </div>
                <div class="prepared-listing-files">
                  <p><strong>Mockup Files:</strong> ${
                    listing.mockup_images_rel &&
                    listing.mockup_images_rel.length > 0
                      ? listing.mockup_images_rel
                          .map((img) => img.split("/").pop())
                          .join(", ")
                      : "None"
                  }</p>
                  <p><strong>Video Files:</strong> ${
                    listing.video_files_rel &&
                    listing.video_files_rel.length > 0
                      ? listing.video_files_rel
                          .map((video) => video.split("/").pop())
                          .join(", ")
                      : "None"
                  }</p>
                </div>
              </div>
              <div class="prepared-listing-actions">
                <button onclick="updatePreparedListing(${index})" class="secondary-button">Update Listing</button>
                <button onclick="uploadPreparedListing(${index})" class="upload-button">Upload to Etsy</button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;

        // Add event listeners for validation
        document.querySelectorAll(".title-input").forEach((input) => {
          input.addEventListener("input", function () {
            const length = this.value.length;
            const parent = this.parentElement;
            const label = parent.querySelector("label span");

            label.textContent = `(${length}/140 characters)`;

            if (length > 140) {
              label.className = "text-danger";
            } else if (length > 130) {
              label.className = "text-warning";
            } else {
              label.className = "text-success";
            }
          });
        });

        document.querySelectorAll(".tags-input").forEach((input) => {
          input.addEventListener("input", function () {
            const tags = this.value
              .split(",")
              .map((tag) => tag.trim())
              .filter((tag) => tag);
            const parent = this.parentElement;
            const tagCount = parent.querySelector(".tag-count");

            tagCount.textContent = `(${tags.length}/13 tags)`;

            if (tags.length > 13) {
              tagCount.className = "tag-count text-danger";
            } else {
              tagCount.className = "tag-count";
            }

            // Update tag display
            const tagContainer = parent.querySelector(".prepared-listing-tags");
            tagContainer.innerHTML = tags
              .map((tag) => {
                const tagLength = tag.length;
                const tagClass = tagLength > 20 ? "tag-danger" : "";
                return `<span class="prepared-listing-tag ${tagClass}" title="${tagLength} characters">${tag}</span>`;
              })
              .join("");
          });
        });
      }

      function updatePreparedListing(index) {
        const titleInput = document.querySelector(
          `.title-input[data-index="${index}"]`
        );
        const descriptionInput = document.querySelector(
          `.description-input[data-index="${index}"]`
        );
        const tagsInput = document.querySelector(
          `.tags-input[data-index="${index}"]`
        );

        if (!titleInput || !descriptionInput || !tagsInput) {
          log("Error: Could not find inputs for listing");
          return;
        }

        const title = titleInput.value;
        const description = descriptionInput.value;
        const tags = tagsInput.value
          .split(",")
          .map((tag) => tag.trim())
          .filter((tag) => tag);

        // Validate
        if (title.length > 140) {
          log("Error: Title must be 140 characters or less");
          return;
        }

        if (tags.length > 13) {
          log("Error: Maximum 13 tags allowed");
          return;
        }

        for (const tag of tags) {
          if (tag.length > 20) {
            log(`Error: Tag '${tag}' exceeds 20 characters`);
            return;
          }
        }

        // Update the listing in memory
        fetch(`/run`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-update-prepared",
            index: index,
            title: title,
            description: description,
            tags: tags,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              log(`Updated listing: ${data.folder_name}`);
            } else {
              log(`Error updating listing: ${data.error}`);
            }
          })
          .catch((error) => {
            log(`Error: ${error.message}`);
          });
      }

      function uploadPreparedListing(index) {
        const draft = document.getElementById("etsy-bulk-draft").checked;

        // Confirm with the user
        if (
          !confirm(`This will upload the selected listing to Etsy. Continue?`)
        ) {
          return;
        }

        // Show loading message
        log(`Uploading prepared listing ${index + 1}...`);

        // Call the API to get the command for uploading the prepared listing
        fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            command: "etsy-upload-prepared",
            index: index,
            draft: draft,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((data) => {
            log(
              `Uploading listing ${data.current}/${data.total}: ${data.title}`
            );

            // Execute the command directly
            return fetch("/run", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                command: "etsy-create",
                folder: data.command.split("--folder ")[1].split(" --")[0],
                productType: data.command.includes("--product_type ")
                  ? data.command.split("--product_type ")[1].split(" --")[0]
                  : "pattern",
                title: data.title,
                description: data.command.includes("--description ")
                  ? data.command.split("--description ")[1].split(" --")[0]
                  : "",
                tags: data.command.includes("--tags ")
                  ? data.command.includes(" --draft")
                    ? data.command
                        .split("--tags ")[1]
                        .split(" --draft")[0]
                        .split(",")
                    : data.command.split("--tags ")[1].split(",")
                  : [],
                draft: draft,
              }),
            });
          })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "An error occurred");
              });
            }
            return response.json();
          })
          .then((result) => {
            // Check if the log contains the listing ID
            const listingIdMatch = /Listing created: (\d+)/.exec(
              document.getElementById("log").innerHTML
            );
            if (listingIdMatch && listingIdMatch[1]) {
              const listingId = listingIdMatch[1];
              const editUrl = `https://www.etsy.com/your/shops/me/listing-editor/edit/${listingId}`;
              log(
                `Successfully uploaded listing to Etsy. Listing ID: ${listingId}`
              );
              log(
                `<a href="${editUrl}" target="_blank" class="etsy-edit-link">Edit listing on Etsy</a>`
              );
            } else {
              log(
                `Successfully uploaded listing to Etsy. Check the logs for details.`
              );
            }
            log(`Updating prepared listings...`);

            // Wait a moment to ensure the upload is complete before removing from UI
            setTimeout(() => {
              // Remove the listing from the prepared listings JSON file
              fetch("/run", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  command: "etsy-remove-uploaded",
                  index: index,
                }),
              })
                .then((response) => {
                  if (!response.ok) {
                    return response.json().then((data) => {
                      throw new Error(data.error || "An error occurred");
                    });
                  }
                  return response.json();
                })
                .then((data) => {
                  if (data.success) {
                    log(`Removed listing from prepared listings.`);

                    // Refresh the entire listings view to ensure correct indexing
                    showPreparedListings();
                  } else {
                    // Just refresh the listings if removal failed
                    showPreparedListings();
                  }
                })
                .catch((error) => {
                  log(`Error removing listing: ${error.message}`);
                  // Refresh listings to ensure UI is in sync
                  showPreparedListings();
                });
            }, 2000); // Wait 2 seconds before removing from prepared listings

            return result;
          })

          .catch((error) => {
            alert(error.message);
            log("Error: " + error.message);
          });
      }

      // Etsy Sub-tab switching
      document.querySelectorAll(".etsy-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          // Remove active class from all etsy tabs
          document.querySelectorAll(".etsy-tab").forEach((t) => {
            t.classList.remove("active");
          });

          // Add active class to clicked tab
          tab.classList.add("active");

          // Hide all etsy tab content
          document.querySelectorAll(".etsy-tab-content").forEach((content) => {
            content.classList.remove("active");
          });

          // Show corresponding etsy tab content
          const tabId = tab.id;
          const contentId = tabId.replace("-tab", "");
          document.getElementById(contentId).classList.add("active");
        });
      });
    </script>
  </body>
</html>
